<!DOCTYPE html>
<html lang="en">
<head>
  <title>Admin Dashboard</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/style.css">
  <style>
    /* Header layout fixes */
    .header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; }
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    .user-shell { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .user-meta { display: flex; flex-direction: column; gap: 0.25rem; }
    .user-name { font-weight: 600; font-size: 0.95rem; }
    .user-role { font-size: 0.8rem; opacity: 0.7; }
    .btn { padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 500; transition: all 0.2s; }
    .logout { background: #ef4444; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
    .theme-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.5rem; border-radius: 50%; transition: all 0.2s; }
    
    /* STATUS BADGES - FIXED FOR DARK MODE */
    .status {
      padding: 0.375rem 0.875rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      display: inline-block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .status.Pending { 
      background: linear-gradient(135deg, #f97316, #fb923c); 
      color: white; 
    }
    .status.InProgress { 
      background: linear-gradient(135deg, #2563eb, #4f46e5); 
      color: white; 
    }
    .status.Resolved { 
      background: linear-gradient(135deg, #16a34a, #22c55e); 
      color: white; 
    }
    
    /* Dark mode status - brighter for visibility */
    body.dark .status.Pending { 
      background: linear-gradient(135deg, #ea580c, #f97316); 
      color: white; 
    }
    body.dark .status.InProgress { 
      background: linear-gradient(135deg, #1d4ed8, #3730a3); 
      color: white; 
    }
    body.dark .status.Resolved { 
      background: linear-gradient(135deg, #15803d, #16a34a); 
      color: white; 
    }
    
    /* Dark mode overrides */
    body.dark .btn { background: #4f46e5; color: white; }
    body.dark .logout { background: #dc2626; }
    body.dark .user-name { color: #f8fafc; }
    body.dark .user-role { color: #cbd5e1; }
    /* Responsive */
    @media (max-width: 768px) { .user-shell { flex-direction: column; gap: 0.5rem; } }
  </style>
</head>
<body>
  <div class="container">

    <!-- PERFECT HEADER (UNCHANGED) -->
    <header class="header">
      <div class="header-left">
        <div class="brand-mark">
          <span class="brand-dot"></span>
        </div>
        <div class="brand-text">
          <h1>Admin Dashboard</h1>
          <p class="muted">Manage student complaints & actions</p>
        </div>
      </div>

      <div class="header-actions">
        <button id="themeToggle" class="theme-btn" aria-label="Toggle theme">🌙</button>
        <div class="user-shell">
          <div class="user-meta">
            <span class="user-name">Administrator</span>
            <span class="user-role muted">System Admin</span>
          </div>
          <a href="/admin/users" class="btn">Manage Users</a>
          <form method="POST" action="/logout" style="margin:0;">
            <button class="logout" type="submit">Logout</button>
          </form>
        </div>
      </div>
    </header>

    <!-- COMPLAINTS TABLE WITH FIXED STATUS -->
    <section class="card">
      <div class="card-title-row">
        <div>
          <h2>Student Complaints</h2>
          <p class="muted">Track, update and resolve complaints efficiently</p>
        </div>
      </div>

      <% if (!complaints || complaints.length === 0) { %>
        <p class="muted">No complaints found.</p>
      <% } else { %>

        <div class="table-wrapper">
          <table class="complaint-table">
            <thead>
              <tr>
                <th>Student</th>
                <th>Title</th>
                <th>Description</th>
                <th>Image</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>

            <tbody>
              <% complaints.forEach(function(c) { %>
                <tr>
                  <td>
                    <span><%= c.studentId?.name || "—" %></span><br>
                    <span class="muted small-text"><%= c.studentId?.id || "" %></span>
                  </td>

                  <td>
                    <strong><%= c.title %></strong>
                  </td>

                  <td>
                    <div class="description-box">
                      <%= c.description %>
                    </div>
                  </td>

                  <td>
                    <% if (c.image) { %>
                      <img
                        class="thumb"
                        src="<%= c.image %>"
                        alt="Complaint Image"
                        onclick="openImage('<%= c.image %>')"
                      >
                    <% } else { %>
                      <span class="muted">No image</span>
                    <% } %>
                  </td>

                  <td>
                    <% if (c.status === "Pending") { %>
                      <span class="status Pending">Pending</span>
                    <% } else if (c.status === "In Progress") { %>
                      <span class="status InProgress">In Progress</span>
                    <% } else { %>
                      <span class="status Resolved">Resolved</span>
                    <% } %>
                  </td>

                  <td class="actions">
                    <!-- Update status -->
                    <form
                      method="POST"
                      action="/admin/status/<%= c._id %>"
                      class="inline-form"
                    >
                      <select name="status">
                        <option value="Pending" <%= c.status==="Pending"?"selected":"" %>>Pending</option>
                        <option value="In Progress" <%= c.status==="In Progress"?"selected":"" %>>In Progress</option>
                        <option value="Resolved" <%= c.status==="Resolved"?"selected":"" %>>Resolved</option>
                      </select>
                      <button type="submit">Update</button>
                    </form>

                    <!-- Delete -->
                    <form
                      method="POST"
                      action="/admin/delete/<%= c._id %>"
                      onsubmit="return confirm('Delete this complaint permanently?');"
                      class="inline-form"
                    >
                      <button type="submit" class="danger">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>

      <% } %>
    </section>

    <!-- SINGLE CLEAN IMAGE MODAL -->
    <div id="imageModal" class="img-modal">
      <span class="close-modal" onclick="closeImage()">&times;</span>
      <img id="modalImage" class="modal-content" />
    </div>

  </div>

  <!-- CONSOLIDATED SCRIPTS (UNCHANGED) -->
  <script>
    // Theme toggle (optimized)
    const toggle = document.getElementById("themeToggle");
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "dark") {
      document.body.classList.add("dark");
      toggle.textContent = "☀️";
    }
    toggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      if (document.body.classList.contains("dark")) {
        localStorage.setItem("theme", "dark");
        toggle.textContent = "☀️";
      } else {
        localStorage.setItem("theme", "light");
        toggle.textContent = "🌙";
      }
    });

    // Single image modal handler
    function openImage(src) {
      document.getElementById("imageModal").style.display = "flex";
      document.getElementById("modalImage").src = src;
    }
    function closeImage() {
      document.getElementById("imageModal").style.display = "none";
    }
    document.getElementById("imageModal").addEventListener("click", (e) => {
      if (e.target.id === "imageModal") closeImage();
    });
  </script>

</body>
</html>
